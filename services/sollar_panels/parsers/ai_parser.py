import csv
import json
import google.generativeai as genai
from dotenv import load_dotenv
import os

load_dotenv()


def ai_parser(csv_path: str, chunk_size: int = 50):
    genai.configure(api_key=os.getenv("GEMINI_API_KEY"))

    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—É –º–æ–¥–µ–ª—å gemini-1.5-flash –∞–±–æ gemini-pro
    model = genai.GenerativeModel(
        model_name="gemini-1.5-flash",
        generation_config={
            "temperature": 0.3,
            "top_p": 1,
            "top_k": 40,
            "max_output_tokens": 999999
        }
    )
    results = []

    with open(csv_path, newline='', encoding='utf-8') as f:
        reader = csv.reader(f)
        headers = next(reader)
        rows = list(reader)
    

        for i in range(0, len(rows), chunk_size):
            chunk = rows[i:i + chunk_size]

            # –§–æ—Ä–º—É—î–º–æ CSV-—Ä—è–¥–æ–∫
            csv_chunk = [headers] + chunk
            csv_text = '\n'.join([','.join(row) for row in csv_chunk])

            prompt = f"""
–î—ñ–π —è–∫ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –ø–∞—Ä—Å–µ—Ä —Ç–∞ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç —ñ–∑ –ø—Ä–æ–¥–∞–∂—É —Å–æ–Ω—è—á–Ω–∏—Ö –ø–∞–Ω–µ–ª–µ–π.

–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ CSV-—Ñ—Ä–∞–≥–º–µ–Ω—Ç, —â–æ –º—ñ—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–ª—ñ–∫ —Ç–æ–≤–∞—Ä—ñ–≤, —Ç–∞ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–æ —Å–æ–Ω—è—á–Ω—ñ –ø–∞–Ω–µ–ª—ñ. –ü–æ–≤–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –≤–∏–≥–ª—è–¥—ñ –º–∞—Å–∏–≤—É JSON-–æ–±'—î–∫—Ç—ñ–≤ —ñ–∑ —Ç–∞–∫–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä–æ—é:

{{
  "brand": brand,
  "name": model,
  "power": power,
  "full_name": full_name,
  "price": price,
  "panel_type": panel_type,
  "cell_type": cell_type,
  "thickness": thickness
}}

üîç –ü—Ä–∞–≤–∏–ª–∞ –ø–∞—Ä—Å–∏–Ω–≥—É:

1. **–ù–∞—è–≤–Ω—ñ—Å—Ç—å**: –ü—Ä–æ–ø—É—Å–∫–∞–π —Ç–æ–≤–∞—Ä–∏, —è–∫–∏—Ö **–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ**.

2. **–ë—Ä–µ–Ω–¥**:
   - –í–∏—Ç—è–≥–Ω–∏ –Ω–∞–∑–≤—É –±—Ä–µ–Ω–¥—É –æ–¥–Ω–∏–º **—á–∏—Å—Ç–∏–º —Å–ª–æ–≤–æ–º**.
   - –í–∏–ø—Ä–∞–≤–ª—è–π —Ç–∏–ø–æ–≤—ñ —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è —Ç–∞ –ø–æ–º–∏–ª–∫–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ñ.

3. **–ù–∞–∑–≤–∞ (name)**:
   - –í–∏—Ç—è–≥–Ω–∏ –º–æ–¥–µ–ª—å –ø–∞–Ω–µ–ª—ñ –º—ñ–∂ –±—Ä–µ–Ω–¥–æ–º —ñ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—é.
   - –Ø–∫—â–æ –º–æ–¥–µ–ª—å –Ω–µ –≤–∫–∞–∑–∞–Ω–∞, –ø–æ–≤–µ—Ä–Ω–∏ —è–∫ `name` –Ω–∞–∑–≤—É –±—Ä–µ–Ω–¥—É.

4. **–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å (power)**:
   - –ü–æ–≤–µ—Ä–Ω–∏ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –ø–∞–Ω–µ–ª—ñ —É **–≤–∞—Ç–∞—Ö (W)** —è–∫ —Ü—ñ–ª–µ —á–∏—Å–ª–æ.
   - –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ, –ª–æ–≥—ñ—á–Ω–æ –≤–∏–∑–Ω–∞—á –Ω–∞–π–±—ñ–ª—å—à —ñ–º–æ–≤—ñ—Ä–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Å–µ—Ä–µ–¥ —á–∏—Å–ª–æ–≤–∏—Ö.
   - –Ø–∫—â–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –Ω–µ–º–æ–∂–ª–∏–≤–æ ‚Äî –ø–æ–≤–µ—Ä–Ω–∏ `0`.

5. **–¶—ñ–Ω–∞**:
   - –°–ø–æ—Ä—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á–∏ –≤ —è–∫—ñ–π –≤–∞–ª—é—Ç—ñ –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è —Ü—ñ–Ω–∏
   - –ó–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞–π **–Ω–∞–π–º–µ–Ω—à—É –æ–ø—Ç–æ–≤—É —Ü—ñ–Ω—É –≤ –¥–æ–ª–∞—Ä–∞—Ö –°–®–ê –∑–∞ —à—Ç—É–∫—É**.
   üßÆ –û—Å–æ–±–ª–∏–≤–æ –≤–∞–∂–ª–∏–≤–æ: 
üìå –Ø–∫—â–æ —Ü—ñ–Ω–∞ –≤–∏–≥–ª—è–¥–∞—î —è–∫ –¥—É–∂–µ –º–∞–ª–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `0.13`, `0,135` —Ç–æ—â–æ), –≤–≤–∞–∂–∞–π, —â–æ —Ü–µ **—Ü—ñ–Ω–∞ –∑–∞ 1 –≤–∞—Ç** (–∞ –Ω–µ 13.5 –¥–æ–ª–∞—Ä—ñ–≤!).
‚úÖ –£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –ø–µ—Ä–µ–º–Ω–æ–∂ —ó—ó –Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –ø–∞–Ω–µ–ª—ñ (—É –≤–∞—Ç–∞—Ö), —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω—É **—Ü—ñ–Ω—É –∑–∞ 1 —à—Ç—É–∫—É**.

‚ÄºÔ∏è –ü–∞–º‚Äô—è—Ç–∞–π:
- `0.13` ‚Üí —Ü–µ **0.13 $/W**, –Ω–µ 13 –¥–æ–ª–∞—Ä—ñ–≤.
- –Ø–∫—â–æ –ø–∞–Ω–µ–ª—å –º–∞—î –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å 425W —ñ —Ü—ñ–Ω–∞ `0.13`, —Ç–æ —Ä–µ–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞: `0.13 * 425 = 55.25$`
   - –í–∏–∑–Ω–∞—á —Ñ–æ—Ä–º–∞—Ç —Ü—ñ–Ω–∏:
     - –Ø–∫—â–æ —Ü—ñ–Ω–∞ –±—ñ–ª—å—à–∞ –∞–±–æ –¥–æ—Ä—ñ–≤–Ω—é—î 1 –¥–æ–ª–∞—Ä–∞–º, –≤–≤–∞–∂–∞–π —ó—ó **—Ü—ñ–Ω–æ—é –∑–∞ 1 —à—Ç**.
     - –Ø–∫—â–æ —Ü—ñ–Ω–∞ –ø—ñ–¥–æ–∑—Ä—ñ–ª–æ –º–∞–ª–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º–µ–Ω—à–µ $1), –≤–≤–∞–∂–∞–π, —â–æ —Ü–µ **—Ü—ñ–Ω–∞ –∑–∞ –≤–∞—Ç**, —ñ –ø–æ–º–Ω–æ–∂ —ó—ó –Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –ø–∞–Ω–µ–ª—ñ.
     - –Ø–∫—â–æ —Ü—ñ–Ω–∞ –≤–∫–∞–∑–∞–Ω–∞ –≤ —ñ–Ω—à—ñ–π –≤–∞–ª—é—Ç—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≥—Ä–∏–≤–Ω—ñ –∞–±–æ —î–≤—Ä–æ), –∫–æ–Ω–≤–µ—Ä—Ç—É–π —ó—ó –≤ –¥–æ–ª–∞—Ä–∏. —Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –≤ —è–∫—ñ–π –≤–∞–ª—é—Ç—ñ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ –∑–∞–ø–∏—Å—É—î —Ü—ñ–Ω—É
     ‚ùó –í–ê–ñ–õ–ò–í–û: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∞–Ω–∞–ª—ñ–∑—É–π —Ñ–æ—Ä–º–∞—Ç —Ü—ñ–Ω–∏ ‚Äî –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞–π **—Ñ—ñ–Ω–∞–ª—å–Ω—É —Ü—ñ–Ω—É –∑–∞ –æ–¥–Ω—É —à—Ç—É–∫—É –≤ –¥–æ–ª–∞—Ä–∞—Ö**.
   - –Ø–∫—â–æ —Ü—ñ–Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω—è, –ø–æ–≤–µ—Ä–Ω–∏ `0`.

6. **full_name**:
   - –ü–æ–≤–Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –Ω–∞–∑–≤–∞ –∞–±–æ –æ–ø–∏—Å –∑ —Ä—è–¥–∫–∞ CSV.

7. **–¢–∏–ø –ø–∞–Ω–µ–ª—ñ (panel_type)**:
   - –í–∏–∑–Ω–∞—á, —á–∏ –ø–∞–Ω–µ–ª—å —î **"–¥–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—é"**  –∞–±–æ **"–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—é"** . –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `"–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è"`.

8. **–¢–∏–ø –∫–ª—ñ—Ç–∏–Ω (cell_type)**:
   - –í–∏–∑–Ω–∞—á, —á–∏ –∫–ª—ñ—Ç–∏–Ω–∏ —î **"n-type"** —á–∏ **"p-type"**. –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `"n-type"`.

9. **–¢–æ–≤—â–∏–Ω–∞ (thickness)**:
   - –¢–æ–≤—â–∏–Ω–∞ –ø–∞–Ω–µ–ª—ñ —É –º—ñ–ª—ñ–º–µ—Ç—Ä–∞—Ö.
   - –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –ø–æ–≤–µ—Ä–Ω–∏ `30`.

–¢–µ–ø–µ—Ä –≤–∏—Ç—è–≥–Ω–∏ –¥–∞–Ω—ñ –ø—Ä–æ —Å–æ–Ω—è—á–Ω—ñ –ø–∞–Ω–µ–ª—ñ –∑ CSV-—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –Ω–∏–∂—á–µ —Ç–∞ –ø–æ–≤–µ—Ä–Ω–∏ –ª–∏—à–µ –º–∞—Å–∏–≤ JSON-–æ–±'—î–∫—Ç—ñ–≤.

–í—Ö—ñ–¥–Ω—ñ CSV-–¥–∞–Ω—ñ:
{csv_text}

‚ùó –ü–æ–≤–µ—Ä–Ω–∏ **—Ç—ñ–ª—å–∫–∏ —á–∏—Å—Ç–∏–π JSON** ‚Äî –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –∞–±–æ —Ç–µ–∫—Å—Ç—É.
"""

            try:
                response = model.generate_content(prompt)
                response_text = response.text
                
                # –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ —Å–∏–º–≤–æ–ª–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –∑–∞–≤–∞–∂–∞—Ç–∏ –ø–∞—Ä—Å–∏–Ω–≥—É JSON
                response_text = response_text.strip()
                if response_text.startswith("```json"):
                    response_text = response_text.replace("```json", "", 1)
                if response_text.endswith("```"):
                    response_text = response_text.rsplit("```", 1)[0]
                response_text = response_text.strip()
                
                # –ü–∞—Ä—Å–∏–º–æ JSON
                json_data = json.loads(response_text)
                results.extend(json_data)
                print(f"–£—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ –±–ª–æ–∫ {i}-{i + len(chunk)}: –∑–Ω–∞–π–¥–µ–Ω–æ {len(json_data)} –∞–∫—É–º—É–ª—è—Ç–æ—Ä—ñ–≤")
            except Exception as e:
                print(f"–ü–æ–º–∏–ª–∫–∞ –Ω–∞ –±–ª–æ—Ü—ñ {i}-{i + chunk_size}: {e}")
                print(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å API: {response.text if 'response' in locals() else '–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ'}")
                continue

    return results
